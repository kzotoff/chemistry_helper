tinymce.PluginManager.add('filelink', function(editor, url) {
	
	function fileListShow() {
		
		editor.windowManager.open({
			title: 'Choose file',
			file : url + '/main.php',
			width : 600,
			height: 450,
			inline : 1,
			buttons: [{
				text: 'Insert',
				classes:'widget btn primary first abs-layout-item',
				onclick: 'submit'
			},
			{
				text: 'Close',
				onclick: 'close'
			}],
			onsubmit: function(e) {
				
				// get iframe contents
				var fileList = $($('.mce-container-body').children('iframe')[0].contentDocument.body);
				
				// check radio selected value and text comment
				var URL = fileList.find('input[name="selector[]"]:checked').length ? fileList.find('input:checked').attr('value') : false;
				if (!URL) {
					alert('check the file you want to link');
					return false;
				}

				var linkText = $.trim(fileList.find('input[data-meaning="link-text"]').val());
				if (linkText == '') {
					linkText = 'link';
				}

				// add to text
				editor.insertContent('<a href="'+URL+'" />'+linkText+'</a>');
			}
		});
	}
	
	// Add a button that opens a window
	editor.addButton('filelink', {
		tooltip: 'Choose file',
		icon : 'link',
		text: '',
		onclick: fileListShow
	});

	// Adds a menu item to the tools menu
	editor.addMenuItem('filelink', {
		text: 'Choose file',
		icon : 'link',
		context: 'insert',
		onclick: fileListShow
	});
});