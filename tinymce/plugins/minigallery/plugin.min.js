tinymce.PluginManager.add('minigallery', function(editor, url) {

	console.log('[ TinyMCE / minigallery ] CAUTION! non-finalized version');
	function minigalleryShow() {
		simpleFilemanager.start(
			'pictures',
			$('.test'),
			'body',
			{
				confirm : function(value) {
					editor.insertContent('<img src="userfiles/images/'+value+'" alt="" />');
				}
			});
				
		
		
		/*
		editor.windowManager.open({
			title: 'Choose an image!!',
			file : url + '/main.php',
			//file : url + '/../../../lib/sfm/simplefilemanager.php?action=list&cat=pictures&path=userfiles/images/',
			width : 600,
			height: 505,
			inline : 1,
			buttons: [{
				text: 'Insert',
				classes:'widget btn primary first abs-layout-item',
				onclick: 'submit'
			},
			{
				text: 'Close',
				onclick: 'close'
			}],
			onsubmit: function(e) {
				
				// get iframe contents
				var imageList = $($('.mce-container-body').children('iframe')[0].contentDocument.body);

				// check all non-folder elementsm, insert link if checked
				var URL;
				imageList.find('.img_link').each(function() {

					var album = $(this).closest('.album_item');
					if (album.find('input[type="checkbox"]').attr('checked') == 'checked') {
						URL = album.find('input[type="text"]').val();
						editor.insertContent('<img src="'+URL+'" alt="" />');
					}
				});
				
				// add to text
			}
		});
		*/
	}
	
	// Add a button that opens a window
	editor.addButton('minigallery', {
		tooltip: 'Choose image',
		icon : 'image',
		text: '',
		onclick: minigalleryShow
	});

	// Adds a menu item to the tools menu
	editor.addMenuItem('chooseimage', {
		text: 'Choose image',
		icon : 'image',
		context: 'insert',
		onclick: minigalleryShow
	});
});